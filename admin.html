<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control | MobyDick Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        :root {
            --admin-primary: #1a1a2e;
            --admin-secondary: #0f3460;
            --admin-accent: #d4af37;
        }
        
        body {
            background: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
            overflow-x: hidden;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--admin-primary) 0%, var(--admin-secondary) 100%);
            color: white;
            min-height: 100vh;
            position: fixed;
            width: 280px;
            box-shadow: 3px 0 15px rgba(0,0,0,0.2);
            border-right: 4px solid var(--admin-accent);
            z-index: 1000;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 20px;
            min-height: 100vh;
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: 100%;
                position: relative;
                min-height: auto;
            }
            .main-content {
                margin-left: 0;
            }
        }
        
        /* Optimizado para tablet portrait */
        @media (max-width: 1200px) and (min-width: 768px) {
            .sidebar {
                width: 220px;
            }
            .main-content {
                margin-left: 220px;
                padding: 15px;
            }
            .stat-card {
                padding: 1rem;
            }
            .stat-card .h1 {
                font-size: 1.8rem;
            }
        }
        
        @media (max-width: 767px) {
            .stat-card {
                margin-bottom: 1rem;
            }
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid var(--admin-accent);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card-small {
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card-small .h4 {
            font-size: 1.2rem;
            margin-bottom: 0.3rem;
        }
        
        .stat-card-small .display-6 {
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .stat-card-connected {
            border-left-color: #20c997;
            background: linear-gradient(135deg, #f8fff9, #e6f7ef);
        }
        
        .btn-admin {
            background: linear-gradient(135deg, var(--admin-accent), #b8941f);
            color: var(--admin-primary);
            font-weight: bold;
            border: none;
            transition: all 0.3s;
        }
        
        .btn-admin:hover {
            background: linear-gradient(135deg, #b8941f, #9c7d19);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(212, 175, 55, 0.4);
        }
        
        /* Modo Escenario */
        .stage-mode {
            background: linear-gradient(135deg, #1a1a2e, #0f3460);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .stage-header {
            background: rgba(212, 175, 55, 0.9);
            color: #1a1a2e;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            text-align: center;
            border: 3px solid #c41e3a;
        }
        
        /* Playlist - Scrollable y arrastrable */
        .playlist-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1.5rem;
            min-height: 500px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .playlist-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .playlist-container::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
        }
        
        .playlist-container::-webkit-scrollbar-thumb {
            background: var(--admin-accent);
            border-radius: 4px;
        }
        
        .playlist-item {
            background: rgba(255, 255, 255, 0.95);
            color: #333;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: move;
            border-left: 5px solid var(--admin-accent);
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }
        
        .playlist-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .playlist-item.played {
            opacity: 0.6;
            text-decoration: line-through;
            background: rgba(255, 255, 255, 0.7);
            border-left-color: #28a745;
        }
        
        .playlist-item.dragging {
            opacity: 0.5;
            transform: scale(1.02);
        }
        
        .song-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-stage {
            background: linear-gradient(135deg, var(--admin-accent), #b8941f);
            color: var(--admin-primary);
            font-weight: bold;
            border: none;
        }
        
        .btn-mark-played {
            background: #28a745;
            color: white;
            border: none;
        }
        
        .btn-mark-played:hover {
            background: #218838;
        }
        
        /* Lista de canciones para agregar */
        .quick-add-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .quick-add-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .quick-add-container::-webkit-scrollbar-thumb {
            background: var(--admin-accent);
            border-radius: 3px;
        }
        
        .quick-song-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        
        .quick-song-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(3px);
        }
        
        /* Canciones en gesti√≥n */
        .song-row {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
        }
        
        .song-row:hover {
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        /* Mensajes del p√∫blico */
        .message-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            border-left: 5px solid #17a2b8;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        .message-content {
            font-size: 0.95rem;
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .message-songs {
            font-size: 0.85rem;
            color: #28a745;
            font-weight: 500;
        }
        
        .btn-delete-message {
            background: transparent;
            border: none;
            color: #dc3545;
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
        }
        
        .btn-delete-message:hover {
            background: #f8d7da;
        }
        
        /* Animaciones */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Notificaciones */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Mejoras visuales para tablet */
        @media (max-width: 1200px) and (min-width: 768px) {
            .stage-header h1 {
                font-size: 1.8rem;
            }
            .stage-header .lead {
                font-size: 1rem;
            }
            .playlist-container {
                min-height: 400px;
                max-height: 500px;
            }
            .quick-add-container {
                max-height: 350px;
            }
        }
        
        /* Modo tablet portrait - escenario especial */
        @media (max-width: 992px) {
            .stage-mode .row {
                flex-direction: column;
            }
            .stage-mode .col-md-4,
            .stage-mode .col-md-8 {
                width: 100%;
                margin-bottom: 1.5rem;
            }
            .playlist-container {
                min-height: 300px;
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="p-4 text-center">
            <img src="https://i.imgur.com/dc8BSdc.png" alt="MobyDick" class="img-fluid mb-3" style="max-height: 80px;">
            <h4 class="mb-0">PANEL DE CONTROL</h4>
            <small class="text-muted">Porter British Pub</small>
        </div>
        
        <hr class="bg-light mx-3">
        
        <nav class="nav flex-column p-3">
            <a href="#dashboard" class="nav-link text-white mb-2 active" onclick="showSection('dashboard')">
                <i class="bi bi-speedometer2 me-2"></i> Dashboard
            </a>
            <a href="#canciones" class="nav-link text-white mb-2" onclick="showSection('canciones')">
                <i class="bi bi-music-note-list me-2"></i> Gesti√≥n de Canciones
            </a>
            <a href="#escenario" class="nav-link text-warning mb-2 fw-bold" onclick="showSection('escenario')">
                <i class="bi bi-mic me-2"></i> MODO ESCENARIO
            </a>
            <a href="#mensajes" class="nav-link text-white mb-2" onclick="showSection('mensajes')">
                <i class="bi bi-chat-text me-2"></i> Mensajes del P√∫blico
            </a>
            <a href="#agregar" class="nav-link text-white mb-2" onclick="showSection('agregar')">
                <i class="bi bi-plus-circle me-2"></i> Agregar Canci√≥n
            </a>
            
            <hr class="bg-light mx-3 my-3">
            
            <div class="mt-3">
                <button onclick="logout()" class="btn btn-sm btn-outline-light w-100 mb-2">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesi√≥n
                </button>
                <button onclick="window.open('index.html', '_blank')" class="btn btn-sm btn-outline-info w-100">
                    <i class="bi bi-eye"></i> Ver P√°gina P√∫blica
                </button>
            </div>
            
            <div class="mt-4 pt-4">
                <small class="text-muted d-block">Conectado:</small>
                <small class="text-warning" id="user-status">Administrador</small>
                <small class="d-block text-muted mt-2" id="song-count-display">0 canciones</small>
                <div class="mt-3 pt-3 border-top">
                    <small class="text-muted d-block">Estad√≠sticas en vivo:</small>
                    <div id="connection-info" class="small text-white">
                        <small class="d-block">Conectados: <span class="text-success">0</span></small>
                        <small class="d-block">Total hoy: <span class="text-info">0</span></small>
                        <small class="d-block">√öltimo reset: <span class="text-muted">Nunca</span></small>
                    </div>
                </div>
            </div>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Dashboard -->
        <div id="dashboard" class="section fade-in">
            <h1 class="h3 mb-4">
                <i class="bi bi-speedometer2 me-2"></i>Panel de Control MobyDick
            </h1>

            <!-- Estad√≠sticas -->
            <div class="row">
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="h1 text-primary mb-2" id="total-canciones">0</div>
                        <p class="text-muted mb-0">Canciones en repertorio</p>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="h1 text-success mb-2" id="total-votos">0</div>
                        <p class="text-muted mb-0">Votos totales</p>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="h1 text-warning mb-2" id="en-playlist">0</div>
                        <p class="text-muted mb-0">En playlist</p>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="stat-card">
                        <div class="h1 text-info mb-2" id="tocadas">0</div>
                        <p class="text-muted mb-0">Tocadas</p>
                    </div>
                </div>
            </div>

            <!-- Estad√≠sticas en tiempo real -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="stat-card stat-card-small stat-card-connected">
                        <h4 class="mb-0"><i class="bi bi-people"></i> Conectados ahora</h4>
                        <div class="display-6 text-success" id="connected-now">0</div>
                        <small class="text-muted">Personas en la app</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card stat-card-small">
                        <h4 class="mb-0"><i class="bi bi-chat"></i> Mensajes</h4>
                        <div class="display-6 text-info" id="total-messages">0</div>
                        <small class="text-muted">Del p√∫blico hoy</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card stat-card-small">
                        <h4 class="mb-0"><i class="bi bi-device-phone"></i> Dispositivos</h4>
                        <div class="display-6 text-warning" id="unique-devices">0</div>
                        <small class="text-muted">√önicos hoy</small>
                    </div>
                </div>
            </div>

            <!-- Acciones r√°pidas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightning"></i> Acciones R√°pidas</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2 col-6">
                            <button class="btn btn-admin w-100" onclick="showSection('escenario')">
                                <i class="bi bi-mic"></i> Ir al Escenario
                            </button>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-primary w-100" onclick="showSection('agregar')">
                                <i class="bi bi-plus-lg"></i> Nueva Canci√≥n
                            </button>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-warning w-100" onclick="resetAllVotes()">
                                <i class="bi bi-arrow-clockwise"></i> Reiniciar Votos
                            </button>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-success w-100" onclick="exportData()">
                                <i class="bi bi-download"></i> Exportar Datos
                            </button>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-warning w-100" onclick="resetConnectedCounter()">
                                <i class="bi bi-people"></i> Reiniciar Conectados
                            </button>
                        </div>
                        <div class="col-md-2 col-6">
                            <button class="btn btn-outline-info w-100" onclick="showSection('mensajes')">
                                <i class="bi bi-chat"></i> Ver Mensajes
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Canciones -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> Top 10 Canciones M√°s Votadas</h5>
                    <small class="text-muted" id="last-update">Actualizando...</small>
                </div>
                <div class="card-body">
                    <div id="top-10-songs">
                        <p class="text-center">Cargando...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n de Canciones -->
        <div id="canciones" class="section fade-in" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-music-note-list me-2"></i>Gesti√≥n de Canciones
                </h1>
                <div>
                    <button class="btn btn-admin" onclick="showSection('agregar')">
                        <i class="bi bi-plus-lg"></i> Agregar Canci√≥n
                    </button>
                </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-8">
                            <input type="text" id="search-songs" class="form-control" placeholder="Buscar canci√≥n o artista...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-outline-secondary w-100" onclick="refreshSongs()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar Lista
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Canciones -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Todas las Canciones</h5>
                    <span class="badge bg-secondary" id="song-count">0</span>
                </div>
                <div class="card-body p-0">
                    <div id="all-songs-list" class="p-3" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-center">Cargando canciones...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODO ESCENARIO -->
        <div id="escenario" class="section stage-mode fade-in" style="display: none;">
            <div class="stage-header">
                <h1 class="display-5 fw-bold">üé∏ MODO ESCENARIO üé§</h1>
                <p class="lead mb-0">Porter British Pub - Control en vivo desde el escenario</p>
                <small class="text-dark">Usa desde tu tableta o celular durante el show</small>
            </div>

            <div class="row">
                <!-- Panel izquierdo: Estad√≠sticas y agregar r√°pido -->
                <div class="col-md-4">
                    <!-- Estad√≠sticas en vivo -->
                    <div class="card bg-dark mb-4">
                        <div class="card-body text-center">
                            <h4 class="mb-3"><i class="bi bi-graph-up"></i> ESTAD√çSTICAS EN VIVO</h4>
                            <div class="row">
                                <div class="col-6 mb-3">
                                    <div class="h2 text-warning" id="live-total">0</div>
                                    <small>Votos totales</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="h2 text-success" id="live-played">0</div>
                                    <small>Tocadas</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="h2 text-info" id="live-remaining">0</div>
                                    <small>Por tocar</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="h2 text-danger" id="live-next">-</div>
                                    <small>Pr√≥xima</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="h2 text-primary" id="live-connected">0</div>
                                    <small>Conectados</small>
                                </div>
                                <div class="col-6 mb-3">
                                    <div class="h2 text-light" id="live-messages">0</div>
                                    <small>Mensajes</small>
                                </div>
                            </div>
                            
                            <hr class="bg-light">
                            
                            <div class="d-grid gap-2">
                                <button onclick="autoGeneratePlaylist()" class="btn btn-admin">
                                    <i class="bi bi-magic"></i> Generar Playlist Autom√°tica
                                </button>
                                <button onclick="markAllAsPlayed()" class="btn btn-mark-played">
                                    <i class="bi bi-check-all"></i> Marcar todas como tocadas
                                </button>
                                <button onclick="clearPlaylist()" class="btn btn-outline-light">
                                    <i class="bi bi-trash"></i> Limpiar Playlist
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Canciones para agregar r√°pido -->
                    <div class="card bg-dark">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> AGREGAR CANCIONES R√ÅPIDAMENTE</h6>
                        </div>
                        <div class="card-body">
                            <div class="quick-add-container" id="quick-add-songs">
                                <p class="text-center">Cargando canciones...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Panel derecho: Playlist -->
                <div class="col-md-8">
                    <div class="card bg-dark">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="bi bi-list-ol"></i> PLAYLIST DEL SHOW</h4>
                            <small class="text-muted">Arrastra para reordenar ‚Ä¢ Haz clic en ‚úì cuando termines</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="playlist-container" id="stage-playlist">
                                <div class="text-center py-5">
                                    <div class="spinner-border text-warning"></div>
                                    <p class="mt-3">Cargando playlist...</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-dark border-top-0">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Total en lista: <span id="playlist-count">0</span> canciones</small>
                                <button onclick="savePlaylistOrder()" class="btn btn-sm btn-outline-light">
                                    <i class="bi bi-save"></i> Guardar Orden
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensajes del P√∫blico -->
        <div id="mensajes" class="section fade-in" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-chat-text me-2"></i>Mensajes del P√∫blico
                </h1>
                <div>
                    <button class="btn btn-outline-danger" onclick="deleteAllMessages()">
                        <i class="bi bi-trash"></i> Eliminar Todos
                    </button>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-info-circle"></i> Informaci√≥n</h5>
                            <p class="card-text">
                                Los mensajes se env√≠an desde la app del p√∫blico junto con sus votos. 
                                M√°ximo 120 caracteres. Ideal para saludos, felicitaciones o peticiones especiales.
                            </p>
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    <div class="h4 mb-0 text-primary" id="messages-today">0</div>
                                    <small>Hoy</small>
                                </div>
                                <div class="me-3">
                                    <div class="h4 mb-0 text-success" id="messages-total">0</div>
                                    <small>Total</small>
                                </div>
                                <div>
                                    <div class="h4 mb-0 text-warning" id="messages-unread">0</div>
                                    <small>Sin leer</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-lightning"></i> Acciones R√°pidas</h5>
                            <div class="d-grid gap-2">
                                <button class="btn btn-outline-primary" onclick="loadMessages()">
                                    <i class="bi bi-arrow-clockwise"></i> Actualizar Mensajes
                                </button>
                                <button class="btn btn-outline-success" onclick="markAllAsRead()">
                                    <i class="bi bi-check-all"></i> Marcar Todos como Le√≠dos
                                </button>
                                <button class="btn btn-outline-info" onclick="exportMessages()">
                                    <i class="bi bi-download"></i> Exportar Mensajes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lista de Mensajes -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-envelope"></i> Todos los Mensajes</h5>
                    <span class="badge bg-secondary" id="messages-count">0</span>
                </div>
                <div class="card-body p-0">
                    <div id="messages-list" class="p-3" style="max-height: 600px; overflow-y: auto;">
                        <p class="text-center">Cargando mensajes...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agregar/Editar Canci√≥n -->
        <div id="agregar" class="section fade-in" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <i class="bi bi-plus-circle me-2"></i><span id="form-title">Agregar Nueva Canci√≥n</span>
                </h1>
                <button class="btn btn-outline-secondary" onclick="showSection('canciones')">
                    <i class="bi bi-arrow-left"></i> Volver a la lista
                </button>
            </div>

            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-body">
                            <form id="song-form">
                                <input type="hidden" id="edit-song-id" value="">
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">T√≠tulo de la Canci√≥n *</label>
                                        <input type="text" id="song-title" class="form-control" required 
                                               placeholder="Ej: Sweet Child O' Mine">
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Artista/Banda *</label>
                                        <input type="text" id="song-artist" class="form-control" required 
                                               placeholder="Ej: Guns N' Roses">
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">G√©nero</label>
                                        <select id="song-genre" class="form-select">
                                            <option value="Rock">Rock</option>
                                            <option value="Hard Rock">Hard Rock</option>
                                            <option value="Metal">Metal</option>
                                            <option value="Pop Rock">Pop Rock</option>
                                            <option value="Alternativo">Alternativo</option>
                                            <option value="Cl√°sico">Cl√°sico</option>
                                            <option value="Grunge">Grunge</option>
                                            <option value="Blues Rock">Blues Rock</option>
                                            <option value="Otro">Otro</option>
                                        </select>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Duraci√≥n (opcional)</label>
                                        <input type="text" id="song-duration" class="form-control" 
                                               placeholder="Ej: 5:56">
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">A√±o (opcional)</label>
                                    <input type="number" id="song-year" class="form-control" 
                                           placeholder="Ej: 1987" min="1950" max="2024">
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Notas para la banda (opcional)</label>
                                    <textarea id="song-notes" class="form-control" rows="3" 
                                              placeholder="Afina√ß√£o especial, tempo, dificultad, etc..."></textarea>
                                </div>
                                
                                <div class="d-grid gap-2">
                                    <button type="submit" id="submit-song-btn" class="btn btn-admin btn-lg">
                                        <i class="bi bi-check-circle"></i> <span id="submit-btn-text">Agregar Canci√≥n al Repertorio</span>
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetForm()">
                                        Limpiar Formulario
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Canciones recientes -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="bi bi-clock-history"></i> √öltimas canciones agregadas</h6>
                        </div>
                        <div class="card-body">
                            <div id="recent-songs">
                                <p class="text-muted text-center mb-0">No hay canciones recientes</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase v8.10.1 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Sortable.js para drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        // ========== CONFIGURACI√ìN ==========
        const firebaseConfig = {
            apiKey: "AIzaSyAitXyfb6Zc9GVEm0X_Hen_QOiA5Y3Aw1U",
            authDomain: "rockrequests.firebaseapp.com",
            projectId: "rockrequests",
            storageBucket: "rockrequests.firebasestorage.app",
            messagingSenderId: "1000216858616",
            appId: "1:1000216858616:web:00bbd448eb034cba15d00d"
        };

        // ========== VARIABLES GLOBALES ==========
        let db = null;
        let allSongs = [];
        let playlistSongs = [];
        let allMessages = [];
        let currentSection = 'dashboard';
        let sortableInstance = null;
        let connectionListener = null;
        let messagesListener = null;

        // ========== INICIALIZAR ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log("üöÄ Iniciando panel de administraci√≥n MobyDick...");
            initializeFirebase();
            setupForm();
            checkAuth();
            updateLastUpdateTime();
            setInterval(updateLastUpdateTime, 60000); // Actualizar cada minuto
        });

        function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                console.log("‚úÖ Firebase inicializado correctamente");
                loadAllData();
                setupConnectionListener(); // Escuchar conexiones
                setupMessagesListener(); // Escuchar mensajes
                setInterval(loadAllData, 10000); // Actualizar cada 10 segundos
            } catch (error) {
                console.error("‚ùå Error inicializando Firebase:", error);
                showNotification("Error de conexi√≥n con Firebase", "danger");
            }
        }

        function checkAuth() {
            const auth = localStorage.getItem('mobydick_admin');
            if (!auth) {
                const pass = prompt("üîê Contrase√±a de administraci√≥n:");
                if (pass === "MobyDick2024") {
                    localStorage.setItem('mobydick_admin', 'true');
                    showNotification("‚úÖ Acceso concedido", "success");
                } else {
                    window.location.href = "index.html";
                }
            }
        }

        // ========== NAVEGACI√ìN ==========
        function showSection(sectionId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.section').forEach(s => {
                s.style.display = 'none';
            });
            
            // Mostrar la secci√≥n seleccionada
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
                section.classList.add('fade-in');
                
                // Actualizar navegaci√≥n activa
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                const activeLink = document.querySelector(`[href="#${sectionId}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                
                currentSection = sectionId;
                
                // Cargar datos espec√≠ficos de la secci√≥n
                if (sectionId === 'canciones') {
                    loadSongsList();
                } else if (sectionId === 'escenario') {
                    loadStageMode();
                } else if (sectionId === 'mensajes') {
                    loadMessages();
                } else if (sectionId === 'agregar') {
                    resetForm();
                }
            }
        }

        // ========== CARGA DE DATOS ==========
        function loadAllData() {
            loadSongs();
            updateConnectionStats();
            updateMessageStats();
        }

        function loadSongs() {
            db.collection("songs").orderBy("title").get()
                .then((snapshot) => {
                    allSongs = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        allSongs.push({
                            id: doc.id,
                            title: data.title || "Sin t√≠tulo",
                            artist: data.artist || "Desconocido",
                            genre: data.genre || "Rock",
                            votes: data.votes || 0,
                            duration: data.duration || "",
                            year: data.year || "",
                            notes: data.notes || "",
                            inPlaylist: data.inPlaylist || false,
                            played: data.played || false,
                            playlistOrder: data.playlistOrder || 999,
                            addedAt: data.addedAt || new Date().toISOString()
                        });
                    });
                    
                    console.log(`üìä ${allSongs.length} canciones cargadas`);
                    
                    // Actualizar contador en sidebar
                    const countDisplay = document.getElementById('song-count-display');
                    if (countDisplay) {
                        countDisplay.textContent = `${allSongs.length} canciones`;
                    }
                    
                    // Actualizar estad√≠sticas
                    updateStats();
                    updateTopSongs();
                    
                    // Si estamos en una secci√≥n espec√≠fica, actualizar su contenido
                    if (currentSection === 'canciones') {
                        loadSongsList();
                    } else if (currentSection === 'escenario') {
                        loadStageMode();
                    }
                    
                })
                .catch((error) => {
                    console.error("‚ùå Error cargando canciones:", error);
                    showNotification("Error cargando canciones", "danger");
                });
        }

        // ========== SISTEMA DE CONEXIONES ==========
        function setupConnectionListener() {
            const counterRef = db.collection('stats').doc('connections');
            
            connectionListener = counterRef.onSnapshot((doc) => {
                if (doc.exists) {
                    updateConnectionStats();
                }
            });
        }

        function updateConnectionStats() {
            const counterRef = db.collection("stats").doc("connections");
            
            counterRef.get().then((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    const currentConnections = data.count || 0;
                    const totalConnections = data.totalConnections || 0;
                    const lastReset = data.lastReset ? new Date(data.lastReset).toLocaleString('es-MX') : "Nunca";
                    
                    // Actualizar en dashboard
                    document.getElementById('connected-now').textContent = currentConnections;
                    
                    // Actualizar en modo escenario
                    document.getElementById('live-connected').textContent = currentConnections;
                    
                    // Mostrar en el sidebar
                    const connectionInfo = document.getElementById('connection-info');
                    if (connectionInfo) {
                        connectionInfo.innerHTML = `
                            <small class="d-block">Conectados: <span class="text-success">${currentConnections}</span></small>
                            <small class="d-block">Total hoy: <span class="text-info">${totalConnections}</span></small>
                            <small class="d-block">√öltimo reset: <span class="text-muted">${lastReset}</span></small>
                        `;
                    }
                }
            }).catch((error) => {
                console.error("Error obteniendo estad√≠sticas de conexi√≥n:", error);
            });
        }

        function resetConnectedCounter() {
            if (confirm("¬øReiniciar contador de personas conectadas a 0?\nEsta acci√≥n afectar√° a todos los usuarios.")) {
                // Guardar en Firebase
                db.collection("stats").doc("connections").set({
                    count: 0,
                    lastReset: new Date().toISOString(),
                    resetBy: "admin",
                    lastConnection: new Date().toISOString(),
                    // Mantener el total de conexiones
                    totalConnections: firebase.firestore.FieldValue.increment(0)
                })
                .then(() => {
                    showNotification("‚úÖ Contador de conectados reiniciado a 0", "success");
                    // Recargar datos
                    updateConnectionStats();
                })
                .catch((error) => {
                    console.error("Error reseteando contador:", error);
                    showNotification("‚ùå Error al reiniciar contador", "danger");
                });
            }
        }

        // ========== SISTEMA DE MENSAJES ==========
        function setupMessagesListener() {
            messagesListener = db.collection("messages")
                .orderBy("sentAt", "desc")
                .limit(50)
                .onSnapshot((snapshot) => {
                    allMessages = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        allMessages.push({
                            id: doc.id,
                            message: data.message || "",
                            deviceId: data.deviceId || "",
                            songs: data.songs || [],
                            sentAt: data.sentAt || new Date().toISOString(),
                            read: data.read || false
                        });
                    });
                    
                    console.log(`üì® ${allMessages.length} mensajes cargados`);
                    
                    updateMessageStats();
                    
                    if (currentSection === 'mensajes') {
                        displayMessages();
                    }
                });
        }

        function loadMessages() {
            if (currentSection === 'mensajes') {
                displayMessages();
            }
        }

        function displayMessages() {
            const container = document.getElementById('messages-list');
            const countElement = document.getElementById('messages-count');
            
            if (!container) return;
            
            if (allMessages.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-chat-text display-1 text-muted"></i>
                        <p class="mt-3">No hay mensajes a√∫n</p>
                        <p class="small text-muted">Los mensajes aparecer√°n cuando el p√∫blico los env√≠e desde la app.</p>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }
            
            let html = '';
            
            // Agrupar mensajes por fecha (hoy, ayer, etc.)
            const groupedMessages = groupMessagesByDate(allMessages);
            
            Object.keys(groupedMessages).forEach(date => {
                html += `
                    <div class="mb-3">
                        <h6 class="text-muted mb-2"><i class="bi bi-calendar"></i> ${date}</h6>
                `;
                
                groupedMessages[date].forEach(msg => {
                    const time = new Date(msg.sentAt).toLocaleTimeString('es-MX', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const songList = msg.songs && msg.songs.length > 0 
                        ? `<div class="message-songs"><i class="bi bi-music-note"></i> ${msg.songs.join(', ')}</div>` 
                        : '';
                    
                    const readClass = msg.read ? '' : 'fw-bold';
                    
                    html += `
                        <div class="message-card">
                            <div class="message-header">
                                <span class="${readClass}">
                                    <i class="bi bi-person-circle"></i> Usuario
                                    <small class="text-muted ms-2">${msg.deviceId.substring(0, 8)}...</small>
                                </span>
                                <div>
                                    <span class="message-time">${time}</span>
                                    <button class="btn-delete-message ms-2" onclick="deleteMessage('${msg.id}')" title="Eliminar mensaje">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="message-content ${readClass}">
                                ${msg.message}
                            </div>
                            ${songList}
                            ${!msg.read ? `
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-success" onclick="markAsRead('${msg.id}')">
                                        <i class="bi bi-check"></i> Marcar como le√≠do
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            container.innerHTML = html;
            if (countElement) countElement.textContent = allMessages.length;
        }

        function groupMessagesByDate(messages) {
            const groups = {};
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            
            messages.forEach(msg => {
                const msgDate = new Date(msg.sentAt);
                const dateString = msgDate.toDateString();
                
                let displayDate;
                if (dateString === today) {
                    displayDate = 'Hoy';
                } else if (dateString === yesterday) {
                    displayDate = 'Ayer';
                } else {
                    displayDate = msgDate.toLocaleDateString('es-MX', { 
                        weekday: 'long', 
                        day: 'numeric', 
                        month: 'long' 
                    });
                }
                
                if (!groups[displayDate]) {
                    groups[displayDate] = [];
                }
                groups[displayDate].push(msg);
            });
            
            return groups;
        }

        function updateMessageStats() {
            const today = new Date().toISOString().split('T')[0];
            
            const messagesToday = allMessages.filter(msg => 
                msg.sentAt.startsWith(today)
            ).length;
            
            const unreadMessages = allMessages.filter(msg => 
                !msg.read
            ).length;
            
            // Obtener dispositivos √∫nicos de hoy
            const todayMessages = allMessages.filter(msg => 
                msg.sentAt.startsWith(today)
            );
            const uniqueDevices = [...new Set(todayMessages.map(msg => msg.deviceId))].length;
            
            // Actualizar dashboard
            document.getElementById('total-messages').textContent = allMessages.length;
            document.getElementById('messages-today').textContent = messagesToday;
            document.getElementById('messages-total').textContent = allMessages.length;
            document.getElementById('messages-unread').textContent = unreadMessages;
            document.getElementById('unique-devices').textContent = uniqueDevices;
            
            // Actualizar modo escenario
            document.getElementById('live-messages').textContent = unreadMessages;
        }

        function markAsRead(messageId) {
            db.collection("messages").doc(messageId).update({
                read: true,
                readAt: new Date().toISOString()
            })
            .then(() => {
                showNotification("‚úÖ Mensaje marcado como le√≠do", "success");
            })
            .catch((error) => {
                console.error("Error marcando mensaje como le√≠do:", error);
                showNotification("‚ùå Error al marcar mensaje", "danger");
            });
        }

        function markAllAsRead() {
            if (allMessages.length === 0) {
                showNotification("No hay mensajes para marcar como le√≠dos", "info");
                return;
            }
            
            if (confirm("¬øMarcar TODOS los mensajes como le√≠dos?")) {
                const batch = db.batch();
                const unreadMessages = allMessages.filter(msg => !msg.read);
                
                if (unreadMessages.length === 0) {
                    showNotification("Todos los mensajes ya est√°n le√≠dos", "info");
                    return;
                }
                
                unreadMessages.forEach(msg => {
                    const msgRef = db.collection("messages").doc(msg.id);
                    batch.update(msgRef, {
                        read: true,
                        readAt: new Date().toISOString()
                    });
                });
                
                batch.commit()
                    .then(() => {
                        showNotification(`‚úÖ ${unreadMessages.length} mensajes marcados como le√≠dos`, "success");
                    })
                    .catch((error) => {
                        console.error("Error marcando mensajes como le√≠dos:", error);
                        showNotification("‚ùå Error al marcar mensajes", "danger");
                    });
            }
        }

        function deleteMessage(messageId) {
            if (confirm("¬øEliminar este mensaje?\nEsta acci√≥n no se puede deshacer.")) {
                db.collection("messages").doc(messageId).delete()
                    .then(() => {
                        showNotification("‚úÖ Mensaje eliminado", "success");
                    })
                    .catch((error) => {
                        console.error("Error eliminando mensaje:", error);
                        showNotification("‚ùå Error al eliminar mensaje", "danger");
                    });
            }
        }

        function deleteAllMessages() {
            if (allMessages.length === 0) {
                showNotification("No hay mensajes para eliminar", "info");
                return;
            }
            
            if (confirm(`¬øEliminar TODOS los ${allMessages.length} mensajes?\nEsta acci√≥n no se puede deshacer.`)) {
                const batch = db.batch();
                
                allMessages.forEach(msg => {
                    const msgRef = db.collection("messages").doc(msg.id);
                    batch.delete(msgRef);
                });
                
                batch.commit()
                    .then(() => {
                        showNotification(`‚úÖ ${allMessages.length} mensajes eliminados`, "success");
                    })
                    .catch((error) => {
                        console.error("Error eliminando mensajes:", error);
                        showNotification("‚ùå Error al eliminar mensajes", "danger");
                    });
            }
        }

        function exportMessages() {
            if (allMessages.length === 0) {
                showNotification("No hay mensajes para exportar", "info");
                return;
            }
            
            const data = {
                exportedAt: new Date().toISOString(),
                totalMessages: allMessages.length,
                messages: allMessages.map(msg => ({
                    message: msg.message,
                    songs: msg.songs,
                    sentAt: msg.sentAt,
                    read: msg.read,
                    deviceId: msg.deviceId
                }))
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mobydick-messages-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Mensajes exportados correctamente", "success");
        }

        // ========== FORMULARIO - CORREGIDO ==========
        function setupForm() {
            const form = document.getElementById('song-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitSong();
                });
            }
        }

        function submitSong() {
            const songId = document.getElementById('edit-song-id').value;
            const title = document.getElementById('song-title').value.trim();
            const artist = document.getElementById('song-artist').value.trim();
            const genre = document.getElementById('song-genre').value;
            const duration = document.getElementById('song-duration').value.trim();
            const year = document.getElementById('song-year').value;
            const notes = document.getElementById('song-notes').value.trim();
            
            if (!title || !artist) {
                showNotification("T√≠tulo y artista son requeridos", "warning");
                return;
            }
            
            const songData = {
                title: title,
                artist: artist,
                genre: genre,
                duration: duration || null,
                notes: notes || null,
                updatedAt: new Date().toISOString()
            };
            
            if (year) songData.year = parseInt(year);
            
            const btn = document.getElementById('submit-song-btn');
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';
            }
            
            if (songId) {
                // EDITAR canci√≥n existente - CORREGIDO
                db.collection("songs").doc(songId).update(songData)
                    .then(() => {
                        showNotification(`‚úÖ Canci√≥n "${title}" actualizada correctamente`, "success");
                        resetForm();
                        loadAllData();
                        showSection('canciones'); // Volver a la lista despu√©s de editar
                    })
                    .catch((error) => {
                        console.error("Error actualizando canci√≥n:", error);
                        showNotification("Error al actualizar canci√≥n", "danger");
                    })
                    .finally(() => {
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-check-circle"></i> Actualizar Canci√≥n';
                        }
                    });
            } else {
                // AGREGAR nueva canci√≥n
                songData.votes = 0;
                songData.addedAt = new Date().toISOString();
                songData.inPlaylist = false;
                songData.played = false;
                songData.playlistOrder = 999;
                
                db.collection("songs").add(songData)
                    .then((docRef) => {
                        console.log("‚úÖ Canci√≥n agregada con ID:", docRef.id);
                        showNotification(`‚úÖ Canci√≥n "${title}" agregada al repertorio`, "success");
                        resetForm();
                        loadAllData();
                        loadRecentSongs();
                    })
                    .catch((error) => {
                        console.error("‚ùå Error agregando canci√≥n:", error);
                        showNotification("Error al agregar canci√≥n", "danger");
                    })
                    .finally(() => {
                        if (btn) {
                            btn.disabled = false;
                            btn.innerHTML = '<i class="bi bi-check-circle"></i> Agregar Canci√≥n al Repertorio';
                        }
                    });
            }
        }

        function resetForm() {
            // Limpiar formulario completamente
            document.getElementById('edit-song-id').value = '';
            document.getElementById('form-title').textContent = 'Agregar Nueva Canci√≥n';
            document.getElementById('submit-btn-text').textContent = 'Agregar Canci√≥n al Repertorio';
            
            // Limpiar todos los campos del formulario
            const form = document.getElementById('song-form');
            if (form) {
                form.reset();
                // Establecer valores por defecto
                document.getElementById('song-genre').value = 'Rock';
            }
        }

        function loadRecentSongs() {
            const container = document.getElementById('recent-songs');
            if (!container) return;
            
            const recent = [...allSongs]
                .sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt))
                .slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = '<p class="text-muted text-center mb-0">No hay canciones recientes</p>';
                return;
            }
            
            let html = '';
            recent.forEach(song => {
                const date = new Date(song.addedAt);
                const timeStr = date.toLocaleTimeString('es-MX', { hour: '2-digit', minute: '2-digit' });
                
                html += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <small class="d-block">${song.title}</small>
                            <small class="text-muted">${song.artist}</small>
                        </div>
                        <small class="text-muted">${timeStr}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== EDITAR CANCI√ìN - CORREGIDO ==========
        function editSong(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (!song) {
                showNotification("No se encontr√≥ la canci√≥n", "warning");
                return;
            }
            
            console.log("üìù Editando canci√≥n:", song);
            
            // Rellenar formulario con los datos actuales
            document.getElementById('edit-song-id').value = song.id;
            document.getElementById('song-title').value = song.title;
            document.getElementById('song-artist').value = song.artist;
            document.getElementById('song-genre').value = song.genre || 'Rock';
            document.getElementById('song-duration').value = song.duration || '';
            document.getElementById('song-year').value = song.year || '';
            document.getElementById('song-notes').value = song.notes || '';
            
            // Cambiar t√≠tulo del formulario
            document.getElementById('form-title').textContent = 'Editar Canci√≥n';
            document.getElementById('submit-btn-text').textContent = 'Actualizar Canci√≥n';
            
            // Ir a la secci√≥n de agregar/editar
            showSection('agregar');
            
            // Scroll al formulario
            setTimeout(() => {
                document.getElementById('song-title').focus();
            }, 300);
        }

        // ========== ELIMINAR CANCI√ìN ==========
        function deleteSong(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (!song) return;
            
            if (confirm(`¬øEliminar la canci√≥n "${song.title}"?\nEsta acci√≥n no se puede deshacer.`)) {
                db.collection("songs").doc(songId).delete()
                    .then(() => {
                        showNotification(`Canci√≥n "${song.title}" eliminada`, "success");
                        loadAllData();
                    })
                    .catch((error) => {
                        console.error("Error eliminando canci√≥n:", error);
                        showNotification("Error al eliminar canci√≥n", "danger");
                    });
            }
        }

        // ========== MODO ESCENARIO ==========
        function loadStageMode() {
            updateLiveStats();
            loadPlaylist();
            loadQuickAddSongs();
            initSortable();
        }

        function loadPlaylist() {
            playlistSongs = allSongs
                .filter(song => song.inPlaylist)
                .sort((a, b) => (a.playlistOrder || 999) - (b.playlistOrder || 999));
            
            const container = document.getElementById('stage-playlist');
            const countElement = document.getElementById('playlist-count');
            
            if (!container) return;
            
            if (playlistSongs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-music-note-beamed display-1 text-muted"></i>
                        <p class="mt-3">Playlist vac√≠a</p>
                        <p class="small text-muted">Agrega canciones desde la lista de la izquierda</p>
                    </div>
                `;
                if (countElement) countElement.textContent = '0';
                return;
            }
            
            let html = '';
            playlistSongs.forEach((song, index) => {
                html += `
                    <div class="playlist-item ${song.played ? 'played' : ''}" data-id="${song.id}">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-secondary me-3" style="min-width: 30px;">${index + 1}</span>
                            <div>
                                <h6 class="mb-1">${song.title}</h6>
                                <small class="text-muted">${song.artist} ‚Ä¢ ${song.votes} votos</small>
                            </div>
                        </div>
                        <div class="song-actions">
                            <button class="btn btn-sm ${song.played ? 'btn-outline-success' : 'btn-success'}" 
                                    onclick="togglePlayed('${song.id}')"
                                    title="${song.played ? 'Marcar como por tocar' : 'Marcar como tocada'}">
                                <i class="bi ${song.played ? 'bi-arrow-counterclockwise' : 'bi-check'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="removeFromPlaylist('${song.id}')" title="Eliminar de la playlist">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            if (countElement) countElement.textContent = playlistSongs.length;
            
            // Inicializar Sortable si no existe
            if (!sortableInstance) {
                initSortable();
            }
        }

        function initSortable() {
            const playlist = document.getElementById('stage-playlist');
            if (!playlist || playlist.children.length === 0) return;
            
            // Destruir instancia anterior si existe
            if (sortableInstance) {
                sortableInstance.destroy();
            }
            
            sortableInstance = Sortable.create(playlist, {
                animation: 150,
                ghostClass: 'dragging',
                onEnd: function() {
                    updatePlaylistOrder();
                }
            });
        }

        function updatePlaylistOrder() {
            const items = document.querySelectorAll('#stage-playlist .playlist-item');
            const batch = db.batch();
            
            items.forEach((item, index) => {
                const songId = item.getAttribute('data-id');
                const songRef = db.collection("songs").doc(songId);
                batch.update(songRef, {
                    playlistOrder: index,
                    updatedAt: new Date().toISOString()
                });
            });
            
            batch.commit()
                .then(() => {
                    showNotification("Orden de playlist actualizado", "success");
                })
                .catch((error) => {
                    console.error("Error actualizando orden:", error);
                    showNotification("Error al actualizar orden", "danger");
                });
        }

        function loadQuickAddSongs() {
            const container = document.getElementById('quick-add-songs');
            if (!container) return;
            
            // Mostrar todas las canciones que NO est√°n en playlist
            // Ordenadas por votos (las m√°s votadas primero)
            const availableSongs = allSongs
                .filter(song => !song.inPlaylist)
                .sort((a, b) => b.votes - a.votes);
            
            if (availableSongs.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay canciones disponibles</p>';
                return;
            }
            
            let html = '';
            availableSongs.forEach(song => {
                html += `
                    <div class="quick-song-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <strong class="d-block">${song.title}</strong>
                                <small class="text-muted">${song.artist}</small>
                                <div class="mt-1">
                                    <span class="badge bg-warning text-dark">${song.votes} votos</span>
                                    ${song.genre ? `<span class="badge bg-secondary ms-1">${song.genre}</span>` : ''}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-admin ms-2" onclick="addToPlaylist('${song.id}')" title="Agregar a playlist">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function addToPlaylist(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (!song) return;
            
            db.collection("songs").doc(songId).update({
                inPlaylist: true,
                playlistOrder: playlistSongs.length,
                addedToPlaylistAt: new Date().toISOString()
            })
            .then(() => {
                showNotification(`"${song.title}" agregada a la playlist`, "success");
                loadAllData();
            })
            .catch((error) => {
                console.error("Error agregando a playlist:", error);
                showNotification("Error al agregar a playlist", "danger");
            });
        }

        function removeFromPlaylist(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (!song) return;
            
            if (confirm(`¬øRemover "${song.title}" de la playlist?`)) {
                db.collection("songs").doc(songId).update({
                    inPlaylist: false,
                    playlistOrder: 999
                })
                .then(() => {
                    showNotification(`"${song.title}" removida de la playlist`, "info");
                    loadAllData();
                })
                .catch((error) => {
                    console.error("Error removiendo de playlist:", error);
                    showNotification("Error al remover de playlist", "danger");
                });
            }
        }

        function togglePlayed(songId) {
            const song = allSongs.find(s => s.id === songId);
            if (!song) return;
            
            const newStatus = !song.played;
            
            db.collection("songs").doc(songId).update({
                played: newStatus,
                playedAt: new Date().toISOString()
            })
            .then(() => {
                showNotification(
                    newStatus ? `"${song.title}" marcada como tocada` : `"${song.title}" marcada como por tocar`,
                    newStatus ? "success" : "info"
                );
                loadAllData();
            })
            .catch((error) => {
                console.error("Error actualizando estado:", error);
                showNotification("Error al actualizar estado", "danger");
            });
        }

        function autoGeneratePlaylist() {
            // Tomar las 10 canciones m√°s votadas que no est√©n en playlist
            const topSongs = allSongs
                .filter(song => !song.inPlaylist)
                .sort((a, b) => b.votes - a.votes)
                .slice(0, 10);
            
            if (topSongs.length === 0) {
                showNotification("No hay canciones disponibles para agregar", "info");
                return;
            }
            
            const batch = db.batch();
            let order = playlistSongs.length;
            
            topSongs.forEach(song => {
                const songRef = db.collection("songs").doc(song.id);
                batch.update(songRef, {
                    inPlaylist: true,
                    played: false,
                    playlistOrder: order++,
                    addedToPlaylistAt: new Date().toISOString()
                });
            });
            
            batch.commit()
                .then(() => {
                    showNotification(`Playlist generada con ${topSongs.length} canciones`, "success");
                    loadAllData();
                })
                .catch((error) => {
                    console.error("Error generando playlist:", error);
                    showNotification("Error al generar playlist", "danger");
                });
        }

        function markAllAsPlayed() {
            if (playlistSongs.length === 0) {
                showNotification("No hay canciones en la playlist", "info");
                return;
            }
            
            if (confirm("¬øMarcar TODAS las canciones de la playlist como tocadas?")) {
                const batch = db.batch();
                
                playlistSongs.forEach(song => {
                    const songRef = db.collection("songs").doc(song.id);
                    batch.update(songRef, {
                        played: true,
                        playedAt: new Date().toISOString()
                    });
                });
                
                batch.commit()
                    .then(() => {
                        showNotification("Todas las canciones marcadas como tocadas", "success");
                        loadAllData();
                    })
                    .catch((error) => {
                        console.error("Error marcando canciones:", error);
                        showNotification("Error al marcar canciones", "danger");
                    });
            }
        }

        function clearPlaylist() {
            if (playlistSongs.length === 0) {
                showNotification("La playlist ya est√° vac√≠a", "info");
                return;
            }
            
            if (confirm("¬øLimpiar TODA la playlist? Esta acci√≥n remover√° todas las canciones.")) {
                const batch = db.batch();
                
                playlistSongs.forEach(song => {
                    const songRef = db.collection("songs").doc(song.id);
                    batch.update(songRef, {
                        inPlaylist: false,
                        playlistOrder: 999
                    });
                });
                
                batch.commit()
                    .then(() => {
                        showNotification("Playlist limpiada correctamente", "success");
                        loadAllData();
                    })
                    .catch((error) => {
                        console.error("Error limpiando playlist:", error);
                        showNotification("Error al limpiar playlist", "danger");
                    });
            }
        }

        function savePlaylistOrder() {
            updatePlaylistOrder();
        }

        function updateLiveStats() {
            const playlistCount = allSongs.filter(s => s.inPlaylist).length;
            const playedCount = allSongs.filter(s => s.played).length;
            const totalVotes = allSongs.reduce((sum, song) => sum + song.votes, 0);
            const nextSong = playlistSongs.find(s => !s.played);
            
            document.getElementById('live-total').textContent = totalVotes;
            document.getElementById('live-played').textContent = playedCount;
            document.getElementById('live-remaining').textContent = playlistCount - playedCount;
            document.getElementById('live-next').textContent = nextSong ? nextSong.title.substring(0, 10) + (nextSong.title.length > 10 ? '...' : '') : '-';
        }

        // ========== ESTAD√çSTICAS ==========
        function updateStats() {
            const totalVotes = allSongs.reduce((sum, song) => sum + song.votes, 0);
            const inPlaylist = allSongs.filter(s => s.inPlaylist).length;
            const played = allSongs.filter(s => s.played).length;
            
            document.getElementById('total-canciones').textContent = allSongs.length;
            document.getElementById('total-votos').textContent = totalVotes;
            document.getElementById('en-playlist').textContent = inPlaylist;
            document.getElementById('tocadas').textContent = played;
        }

        function updateTopSongs() {
            const container = document.getElementById('top-10-songs');
            if (!container) return;
            
            const top = [...allSongs]
                .sort((a, b) => b.votes - a.votes)
                .slice(0, 10);
            
            if (top.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay votos a√∫n</p>';
                return;
            }
            
            let html = '';
            top.forEach((song, index) => {
                html += `
                    <div class="song-row mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <span class="badge bg-primary me-2">${index + 1}</span>
                                <strong>${song.title}</strong>
                                <small class="d-block text-muted">${song.artist}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success">${song.votes} votos</span>
                                ${song.inPlaylist ? '<span class="badge bg-warning text-dark ms-1">En playlist</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ========== LISTA DE CANCIONES ==========
        function loadSongsList() {
            const container = document.getElementById('all-songs-list');
            const countElement = document.getElementById('song-count');
            
            if (!container) return;
            
            if (allSongs.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No hay canciones en el repertorio</p>';
                if (countElement) countElement.textContent = '0';
                return;
            }
            
            let html = '';
            allSongs.forEach(song => {
                html += `
                    <div class="song-row mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="flex: 1;">
                                <strong>${song.title}</strong>
                                <small class="d-block text-muted">${song.artist} ‚Ä¢ ${song.genre || 'Sin g√©nero'}</small>
                                <div class="mt-1">
                                    <span class="badge bg-success">${song.votes} votos</span>
                                    ${song.inPlaylist ? '<span class="badge bg-warning text-dark ms-1">En playlist</span>' : ''}
                                    ${song.played ? '<span class="badge bg-info ms-1">Tocada</span>' : ''}
                                </div>
                            </div>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-secondary me-2">${song.duration || '--:--'}</span>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="editSong('${song.id}')" title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSong('${song.id}')" title="Eliminar">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            if (countElement) countElement.textContent = allSongs.length;
            
            // Configurar b√∫squeda
            const searchInput = document.getElementById('search-songs');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const term = e.target.value.toLowerCase().trim();
                    
                    if (term === '') {
                        loadSongsList();
                        return;
                    }
                    
                    const filtered = allSongs.filter(song => 
                        song.title.toLowerCase().includes(term) ||
                        song.artist.toLowerCase().includes(term) ||
                        (song.genre && song.genre.toLowerCase().includes(term))
                    );
                    
                    if (filtered.length === 0) {
                        container.innerHTML = '<p class="text-center text-muted">No se encontraron canciones</p>';
                        if (countElement) countElement.textContent = '0';
                        return;
                    }
                    
                    let filteredHtml = '';
                    filtered.forEach(song => {
                        filteredHtml += `
                            <div class="song-row mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div style="flex: 1;">
                                        <strong>${song.title}</strong>
                                        <small class="d-block text-muted">${song.artist} ‚Ä¢ ${song.genre || 'Sin g√©nero'}</small>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-success me-2">${song.votes} votos</span>
                                        <button class="btn btn-sm btn-outline-primary me-1" onclick="editSong('${song.id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSong('${song.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = filteredHtml;
                    if (countElement) countElement.textContent = filtered.length;
                });
            }
        }

        // ========== HERRAMIENTAS ==========
        function refreshSongs() {
            loadAllData();
            showNotification("Lista de canciones actualizada", "success");
        }

        function resetAllVotes() {
            if (allSongs.length === 0) {
                showNotification("No hay canciones para reiniciar", "info");
                return;
            }
            
            if (confirm("¬øReiniciar TODOS los votos a cero?\nEsta acci√≥n no se puede deshacer.")) {
                const batch = db.batch();
                
                allSongs.forEach(song => {
                    const songRef = db.collection("songs").doc(song.id);
                    batch.update(songRef, { votes: 0 });
                });
                
                batch.commit()
                    .then(() => {
                        showNotification("Todos los votos han sido reiniciados", "success");
                        loadAllData();
                    })
                    .catch((error) => {
                        console.error("Error reiniciando votos:", error);
                        showNotification("Error al reiniciar votos", "danger");
                    });
            }
        }

        function exportData() {
            const data = {
                exportedAt: new Date().toISOString(),
                totalSongs: allSongs.length,
                totalVotes: allSongs.reduce((sum, song) => sum + song.votes, 0),
                songs: allSongs.map(song => ({
                    title: song.title,
                    artist: song.artist,
                    genre: song.genre,
                    votes: song.votes,
                    duration: song.duration,
                    year: song.year,
                    inPlaylist: song.inPlaylist,
                    played: song.played,
                    addedAt: song.addedAt
                }))
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mobydick-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification("Datos exportados correctamente", "success");
        }

        function logout() {
            localStorage.removeItem('mobydick_admin');
            window.location.href = "index.html";
        }

        // ========== UTILIDADES ==========
        function showNotification(message, type = "info") {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show notification`;
            notification.innerHTML = `
                <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
                <div>${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-eliminar despu√©s de 5 segundos
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('es-MX', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const element = document.getElementById('last-update');
            if (element) {
                element.textContent = `√öltima actualizaci√≥n: ${timeStr}`;
            }
        }

        // Hacer funciones globales
        window.showSection = showSection;
        window.logout = logout;
        window.editSong = editSong;
        window.deleteSong = deleteSong;
        window.refreshSongs = refreshSongs;
        window.resetAllVotes = resetAllVotes;
        window.exportData = exportData;
        window.addToPlaylist = addToPlaylist;
        window.removeFromPlaylist = removeFromPlaylist;
        window.togglePlayed = togglePlayed;
        window.autoGeneratePlaylist = autoGeneratePlaylist;
        window.markAllAsPlayed = markAllAsPlayed;
        window.clearPlaylist = clearPlaylist;
        window.savePlaylistOrder = savePlaylistOrder;
        window.resetForm = resetForm;
        window.resetConnectedCounter = resetConnectedCounter;
        window.loadMessages = loadMessages;
        window.markAsRead = markAsRead;
        window.deleteMessage = deleteMessage;
        window.markAllAsRead = markAllAsRead;
        window.deleteAllMessages = deleteAllMessages;
        window.exportMessages = exportMessages;

    </script>
</body>
</html>